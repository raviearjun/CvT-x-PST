# ============================================================
# CvT-21 with Pyramid Sparse Transformer (PST) Configuration
# ============================================================
# Configuration for training CvT-PST on Paddy Disease Dataset
#
# This config extends the original CvT-21 configuration with PST module
# for enhanced multi-scale feature processing on 10 paddy disease classes.
#
# Author: CvT-x-PST Project
# Compatible with: Google Colab, PyTorch >= 1.8.0

# Dataset Configuration
DATASET:
  ROOT: "/content/CvT/paddy_disease_dataset/"
  DATASET: "imagenet"
  DATA_FORMAT: "jpg"
  NUM_CLASSES: 10
  TEST_SET: "test"
  VAL_SET: "val"
  TRAIN_SET: "train"

# Model Configuration
MODEL:
  NAME: "cvt_pst"
  NUM_CLASSES: 10
  PRETRAINED: "/content/CvT/CvT-21-224x224-IN-1k.pth"
  INIT_WEIGHTS: True
  PRETRAINED_LAYERS: ["*"]

  # CvT-21 Backbone Configuration
  SPEC:
    PATCH_SIZE: [7, 3, 3]
    PATCH_STRIDE: [4, 2, 2]
    PATCH_PADDING: [2, 1, 1]
    DIM_EMBED: [64, 192, 384]
    NUM_HEADS: [1, 3, 6]
    DEPTH: [1, 2, 10]
    MLP_RATIO: [4.0, 4.0, 4.0]
    ATTN_DROP_RATE: [0.0, 0.0, 0.0]
    DROP_RATE: [0.0, 0.0, 0.0]
    DROP_PATH_RATE: [0.0, 0.0, 0.1]
    QKV_BIAS: [True, True, True]
    CLS_TOKEN: [False, False, True]
    POS_EMBED: [False, False, True]
    QKV_PROJ_METHOD: ["dw_bn", "dw_bn", "dw_bn"]
    KERNEL_QKV: [3, 3, 3]
    PADDING_QKV: [1, 1, 1]
    STRIDE_QKV: [2, 2, 2]
    PADDING_KV: [1, 1, 1]
    STRIDE_KV: [2, 2, 2]

  # PST Module Configuration
  PST:
    ENABLED: True
    SCALES: [1, 2, 4, 8] # Multi-scale pyramid levels
    REDUCTION_RATIO: 4 # Channel reduction for efficiency
    DROPOUT: 0.1 # Dropout rate in PST
    USE_RESIDUAL: True # Enable residual connections

# Training Configuration
TRAIN:
  AUTO_RESUME: True
  CHECKPOINT_FREQ: 5
  CHECKPOINT_HISTORY_LIMIT: 10
  EVAL_FREQ: 5
  PRINT_FREQ: 100

  # Progressive Training Strategy
  PROGRESSIVE:
    ENABLED: True
    PHASE1_EPOCHS: 15 # Freeze backbone, train PST only
    PHASE2_EPOCHS: 15 # Fine-tune entire model
    BACKBONE_LR_RATIO: 0.1 # Lower LR for backbone in phase 2

  # Batch and Data Loading
  BATCH_SIZE_PER_GPU: 32
  SHUFFLE: True
  NUM_WORKERS: 4
  PIN_MEMORY: True

  # Optimizer Configuration
  OPTIMIZER: "adamw"
  BASE_LR: 0.0005
  WARMUP_LR: 0.00001
  MIN_LR: 0.00001

  # Learning Rate Schedule
  LR_SCHEDULER:
    NAME: "cosine"
    DECAY_EPOCHS: 30
    DECAY_RATE: 0.1
    WARMUP_EPOCHS: 5
    WARMUP_PREFIX: True

  # Regularization
  WEIGHT_DECAY: 0.05
  MOMENTUM: 0.9
  NESTEROV: True
  GAMMA1: 0.99
  GAMMA2: 0.0

  # Data Augmentation
  USE_MIXUP: True
  MIXUP_ALPHA: 0.8
  USE_CUTMIX: True
  CUTMIX_ALPHA: 1.0
  MIXUP_SWITCH_PROB: 0.5
  MIXUP_MODE: "batch"

  # Image Preprocessing
  IMAGE_SIZE: [224, 224]
  INTERPOLATION: "bicubic"
  MEAN: [0.485, 0.456, 0.406]
  STD: [0.229, 0.224, 0.225]

  # Random Augmentation
  AUTO_AUGMENT: "rand-m9-mstd0.5-inc1"
  RE_PROB: 0.25
  RE_MODE: "pixel"
  RE_COUNT: 1

# Testing/Validation Configuration
TEST:
  DATA_SET: "imagenet"
  BATCH_SIZE_PER_GPU: 32
  CENTER_CROP: True
  TEST_CROP: True

  # Test Time Augmentation
  USE_TTA: False
  TTA_SIZE: 256

  # Model Evaluation
  MODEL_FILE: ""
  USE_EMA: False

# System Configuration
CUDNN:
  BENCHMARK: True
  DETERMINISTIC: False
  ENABLED: True

# Output Configuration
OUTPUT_DIR: "/content/output"
LOG_DIR: "/content/CvT/logs"
SAVE_DIR: "/content/output"

# Distributed Training (for multi-GPU)
GPUS: 1
WORKERS: 4
PRINT_FREQ: 100
SAVE_FREQ: 1

# Random Seed
SEED: 42

# Loss Function
LOSS:
  NAME: "CrossEntropyLoss"
  LABEL_SMOOTHING: 0.1

# Metrics
METRICS:
  ACCURACY: True
  TOP5_ACCURACY: True
  F1_SCORE: True
  PRECISION: True
  RECALL: True

# Early Stopping
EARLY_STOPPING:
  ENABLED: True
  PATIENCE: 10
  MIN_DELTA: 0.001
  MONITOR: "val_acc"
  MODE: "max"

# Model Checkpointing
CHECKPOINT:
  SAVE_BEST_ONLY: True
  SAVE_LAST: True
  MONITOR: "val_acc"
  MODE: "max"

# Debug Mode
DEBUG: False
VERBOSE: True

# Experiment Tracking
EXPERIMENT:
  NAME: "cvt_pst_paddy_disease"
  TAGS: ["cvt", "pst", "paddy", "disease", "classification"]
  NOTES: "CvT-21 with Pyramid Sparse Transformer for paddy disease classification"
